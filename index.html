<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Card Info | King Street Cards</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #FFFFFF;
      color: #1F2937;
      line-height: 1.5;
      padding: 16px;
      padding-bottom: 40px;
    }
    
    .header {
      text-align: center;
      padding: 12px 0 20px;
      border-bottom: 1px solid #E5E7EB;
      margin-bottom: 20px;
    }
    
    .header h1 {
      font-size: 14px;
      font-weight: 600;
      color: #9CA3AF;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    
    .card-image-container {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    .card-image {
      width: 180px;
      height: 260px;
      object-fit: cover;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .placeholder-image {
      width: 180px;
      height: 260px;
      background: linear-gradient(145deg, #F3F4F6, #E5E7EB);
      border-radius: 8px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .placeholder-image svg {
      width: 64px;
      height: 64px;
      margin-bottom: 12px;
      opacity: 0.4;
    }
    
    .placeholder-image span {
      font-size: 12px;
      color: #9CA3AF;
      font-weight: 500;
    }
    
    .card-title {
      text-align: center;
      margin-bottom: 16px;
    }
    
    .card-title .year-brand {
      font-size: 14px;
      color: #6B7280;
      font-weight: 500;
    }
    
    .card-title .subject {
      font-size: 22px;
      font-weight: 700;
      color: #111827;
      margin: 4px 0;
    }
    
    .grade-badges {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 12px;
    }
    
    .badge {
      padding: 6px 14px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
    }
    
    .badge-grader {
      background: #1E40AF;
      color: white;
    }
    
    .badge-grade {
      background: #059669;
      color: white;
    }
    
    .section {
      background: #F9FAFB;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .section-title {
      font-size: 11px;
      font-weight: 600;
      color: #9CA3AF;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 12px;
    }
    
    .pop-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .pop-item {
      text-align: center;
      background: white;
      padding: 12px;
      border-radius: 8px;
    }
    
    .pop-item .value {
      font-size: 24px;
      font-weight: 700;
      color: #111827;
    }
    
    .pop-item .label {
      font-size: 11px;
      color: #6B7280;
      margin-top: 2px;
    }
    
    .link-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      border-top: 1px solid #E5E7EB;
      margin-top: 8px;
    }
    
    .link-row a {
      color: #2563EB;
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .link-row a:hover {
      text-decoration: underline;
    }
    
    .price-main {
      text-align: center;
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .price-main .value {
      font-size: 36px;
      font-weight: 700;
      color: #059669;
    }
    
    .price-main .label {
      font-size: 12px;
      color: #6B7280;
      margin-top: 4px;
    }
    
    .price-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 8px;
    }
    
    .price-detail {
      background: white;
      padding: 12px;
      border-radius: 8px;
    }
    
    .price-detail .label {
      font-size: 11px;
      color: #6B7280;
    }
    
    .price-detail .value {
      font-size: 16px;
      font-weight: 600;
      color: #111827;
      margin-top: 2px;
    }
    
    .price-detail .sub {
      font-size: 11px;
      color: #9CA3AF;
    }
    
    .ebay-listing {
      display: flex;
      align-items: center;
      gap: 12px;
      background: white;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
      text-decoration: none;
      color: inherit;
      transition: background 0.2s;
    }
    
    .ebay-listing:hover {
      background: #F3F4F6;
    }
    
    .ebay-listing img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      flex-shrink: 0;
    }
    
    .ebay-listing .info {
      flex: 1;
      min-width: 0;
    }
    
    .ebay-listing .title {
      font-size: 13px;
      font-weight: 500;
      color: #374151;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .ebay-listing .seller {
      font-size: 11px;
      color: #9CA3AF;
    }
    
    .ebay-listing .price {
      font-size: 16px;
      font-weight: 700;
      color: #059669;
      white-space: nowrap;
    }
    
    .ebay-listing .arrow {
      color: #9CA3AF;
      font-size: 18px;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #6B7280;
    }
    
    .loading .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid #E5E7EB;
      border-top-color: #2563EB;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error {
      text-align: center;
      padding: 60px 20px;
      color: #DC2626;
    }
    
    .error svg {
      width: 48px;
      height: 48px;
      margin-bottom: 12px;
      opacity: 0.6;
    }
    
    .no-listings {
      text-align: center;
      padding: 20px;
      color: #9CA3AF;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="loading">
      <div class="spinner"></div>
      <div>Loading card info...</div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://jltbftzrgnfxxrrmmqlp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsdGJmdHpyZ25meHhycm1tcWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MDAzNTAsImV4cCI6MjA4NTM3NjM1MH0.le74kvc9j7qf7eGH84L5iZ-ng5m6ZmiyXH9-zykJRZQ';

    async function supabaseQuery(endpoint) {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      return response.json();
    }

    function formatCurrency(value) {
      if (value === null || value === undefined || isNaN(value)) return '—';
      return `$${parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function getPlaceholderHTML() {
      return `
        <div class="placeholder-image">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="2" width="18" height="20" rx="2" />
            <circle cx="12" cy="10" r="3" />
            <path d="M6 18h12" />
          </svg>
          <span>Image Not Available</span>
        </div>
      `;
    }

    async function loadCard() {
      const params = new URLSearchParams(window.location.search);
      const kscId = params.get('id');
      
      if (!kscId) {
        showError('No card ID provided');
        return;
      }

      try {
        // Fetch card data
        const cards = await supabaseQuery(`cards?ksc_id=eq.${kscId}`);
        if (!cards || cards.length === 0) {
          showError('Card not found');
          return;
        }
        const card = cards[0];

        // Fetch price history
        const priceHistory = await supabaseQuery(`price_history?ksc_id=eq.${kscId}&source=eq.cardladder&order=fetched_at.desc&limit=1`);
        const clPrice = priceHistory?.[0] || null;

        // Fetch eBay listings (BIN only)
        const ebayListings = await supabaseQuery(`ebay_listings?ksc_id=eq.${kscId}&order=price.asc&limit=5`);
        const binListings = (ebayListings || []).filter(l => l.buying_option?.includes('FIXED_PRICE'));

        renderCard(card, clPrice, binListings);
      } catch (e) {
        console.error(e);
        showError('Failed to load card data');
      }
    }

    function showError(message) {
      document.getElementById('app').innerHTML = `
        <div class="error">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="8" x2="12" y2="12" />
            <line x1="12" y1="16" x2="12.01" y2="16" />
          </svg>
          <div>${message}</div>
        </div>
      `;
    }

    function renderCard(card, clPrice, ebayListings) {
      const clValue = clPrice?.price ? parseFloat(clPrice.price) : null;
      
      // CardLadder Sales Link API - direct link using grader and cert
      const clUrl = card.grader && card.cert 
        ? `https://app.cardladder.com/search?grader=${card.grader.toLowerCase()}&cert=${card.cert}`
        : null;
      
      document.getElementById('app').innerHTML = `
        <!-- Header -->
        <div class="header">
          <h1>King Street Cards</h1>
        </div>

        <!-- Card Image -->
        <div class="card-image-container">
          ${card.front_image_url 
            ? `<img src="${card.front_image_url}" alt="Card" class="card-image" onclick="window.open('${card.front_image_url}', '_blank')">`
            : getPlaceholderHTML()
          }
        </div>

        <!-- Card Title -->
        <div class="card-title">
          <div class="year-brand">${card.year || ''} ${card.brand || ''}</div>
          <div class="subject">${card.subject || 'Unknown Card'}</div>
          ${card.card_number ? `<div class="year-brand">#${card.card_number}</div>` : ''}
          <div class="grade-badges">
            <span class="badge badge-grader">${(card.grader || 'PSA').toUpperCase()}</span>
            <span class="badge badge-grade">${card.grade || '—'}${card.grade_description ? ` ${card.grade_description}` : ''}</span>
          </div>
        </div>

        <!-- Population Section -->
        <div class="section">
          <div class="section-title">Population</div>
          <div class="pop-grid">
            <div class="pop-item">
              <div class="value">${card.population?.toLocaleString() ?? '—'}</div>
              <div class="label">This Grade</div>
            </div>
            <div class="pop-item">
              <div class="value">${card.population_higher?.toLocaleString() ?? '—'}</div>
              <div class="label">Higher Grades</div>
            </div>
          </div>
          ${card.psa_url ? `
            <div class="link-row">
              <span></span>
              <a href="${card.psa_url}" target="_blank">View on PSA →</a>
            </div>
          ` : ''}
        </div>

        <!-- Pricing Section -->
        <div class="section">
          <div class="section-title">Pricing</div>
          ${clPrice ? `
          <div class="price-main">
            <div class="value">${formatCurrency(clValue)}</div>
            <div class="label">CardLadder Estimate</div>
          </div>
          <div class="price-details">
            <div class="price-detail">
              <div class="label">Last Sale</div>
              <div class="value">${formatCurrency(clPrice?.last_sale_price)}</div>
              <div class="sub">${formatDate(clPrice?.last_sale_date)}</div>
            </div>
            <div class="price-detail">
              <div class="label">1 Year Volume</div>
              <div class="value">${clPrice?.velocity_1yr ?? '—'}</div>
              <div class="sub">sales</div>
            </div>
          </div>
          ${clUrl ? `
            <div class="link-row">
              <span></span>
              <a href="${clUrl}" target="_blank">View Sales History →</a>
            </div>
          ` : ''}
          ` : '<div class="no-listings">No pricing data available</div>'}
        </div>

        <!-- eBay Listings Section -->
        <div class="section">
          <div class="section-title">Available on eBay</div>
          ${ebayListings.length > 0 ? ebayListings.map(listing => `
            <a href="${listing.item_url}" target="_blank" class="ebay-listing">
              ${listing.image_url 
                ? `<img src="${listing.image_url}" alt="">`
                : `<div style="width:50px;height:50px;background:#E5E7EB;border-radius:6px;"></div>`
              }
              <div class="info">
                <div class="title">${listing.title}</div>
                <div class="seller">${listing.seller || 'eBay Seller'}</div>
              </div>
              <div class="price">${formatCurrency(listing.price)}</div>
              <div class="arrow">›</div>
            </a>
          `).join('') : `
            <div class="no-listings">No active listings found</div>
          `}
        </div>
      `;
    }

    // Initialize
    loadCard();
  </script>
</body>
</html>
