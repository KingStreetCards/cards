<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>King Street Cards</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #FFFFFF;
      color: #1F2937;
      line-height: 1.5;
      min-height: 100vh;
      overflow: hidden;
    }
    
    /* Splash Screen */
    .splash {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
      padding: 40px;
      background: linear-gradient(135deg, #FEF3C7 0%, #FFFFFF 50%, #FEF3C7 100%);
    }
    
    .splash-logo {
      font-size: 48px;
      font-weight: 700;
      color: #D97706;
      margin-bottom: 20px;
    }
    
    .splash-icon {
      width: 120px;
      height: 120px;
      margin-bottom: 30px;
      animation: pulse 2s ease-in-out infinite;
    }
    
    .splash-icon svg {
      width: 100%;
      height: 100%;
      color: #D97706;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }
    
    .splash-text {
      font-size: 28px;
      font-weight: 600;
      color: #374151;
      margin-bottom: 10px;
    }
    
    .splash-subtext {
      font-size: 18px;
      color: #6B7280;
    }
    
    /* Main Content */
    .main-content {
      display: none;
      height: 100vh;
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 100px;
    }
    
    .main-content.active {
      display: block;
    }
    
    .header {
      text-align: center;
      padding: 16px 0 24px;
      border-bottom: 2px solid #F3F4F6;
      margin-bottom: 24px;
    }
    
    .header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #D97706;
      letter-spacing: 1px;
    }
    
    .card-image-container {
      display: flex;
      justify-content: center;
      margin-bottom: 24px;
    }
    
    .card-image {
      width: 200px;
      height: 280px;
      object-fit: cover;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    
    .placeholder-image {
      width: 200px;
      height: 280px;
      background: linear-gradient(145deg, #F3F4F6, #E5E7EB);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    
    .placeholder-image svg {
      width: 80px;
      height: 80px;
      margin-bottom: 16px;
      opacity: 0.4;
    }
    
    .placeholder-image span {
      font-size: 14px;
      color: #9CA3AF;
      font-weight: 500;
    }
    
    .card-title {
      text-align: center;
      margin-bottom: 24px;
    }
    
    .card-title .year-brand {
      font-size: 16px;
      color: #6B7280;
      font-weight: 500;
    }
    
    .card-title .subject {
      font-size: 28px;
      font-weight: 700;
      color: #111827;
      margin: 6px 0;
    }
    
    .grade-badges {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 16px;
    }
    
    .badge {
      padding: 8px 18px;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
    }
    
    .badge-grader {
      background: #1E40AF;
      color: white;
    }
    
    .badge-grade {
      background: #059669;
      color: white;
    }
    
    .section {
      background: #F9FAFB;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 12px;
      font-weight: 600;
      color: #9CA3AF;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }
    
    .pop-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .pop-item {
      text-align: center;
      background: white;
      padding: 16px;
      border-radius: 12px;
    }
    
    .pop-item .value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
    }
    
    .pop-item .label {
      font-size: 12px;
      color: #6B7280;
      margin-top: 4px;
    }
    
    .link-btn {
      display: block;
      width: 100%;
      padding: 14px;
      background: #2563EB;
      color: white;
      text-align: center;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 600;
      font-size: 15px;
      margin-top: 12px;
      border: none;
      cursor: pointer;
    }
    
    .link-btn:hover {
      background: #1D4ED8;
    }
    
    .link-btn.secondary {
      background: #F3F4F6;
      color: #374151;
    }
    
    .link-btn.secondary:hover {
      background: #E5E7EB;
    }
    
    .price-main {
      text-align: center;
      background: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 16px;
    }
    
    .price-main .value {
      font-size: 48px;
      font-weight: 700;
      color: #059669;
    }
    
    .price-main .label {
      font-size: 14px;
      color: #6B7280;
      margin-top: 6px;
    }
    
    .price-details {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .price-detail {
      background: white;
      padding: 16px;
      border-radius: 12px;
    }
    
    .price-detail .label {
      font-size: 12px;
      color: #6B7280;
    }
    
    .price-detail .value {
      font-size: 20px;
      font-weight: 600;
      color: #111827;
      margin-top: 4px;
    }
    
    .price-detail .sub {
      font-size: 12px;
      color: #9CA3AF;
    }
    
    .ebay-listing {
      display: flex;
      align-items: center;
      gap: 14px;
      background: white;
      padding: 14px;
      border-radius: 12px;
      margin-bottom: 10px;
      text-decoration: none;
      color: inherit;
    }
    
    .ebay-listing img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
    }
    
    .ebay-listing .info {
      flex: 1;
      min-width: 0;
    }
    
    .ebay-listing .title {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .ebay-listing .seller {
      font-size: 12px;
      color: #9CA3AF;
    }
    
    .ebay-listing .price {
      font-size: 18px;
      font-weight: 700;
      color: #059669;
      white-space: nowrap;
    }
    
    .no-listings {
      text-align: center;
      padding: 24px;
      color: #9CA3AF;
      font-size: 15px;
    }
    
    /* Back Button */
    .back-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      padding: 18px;
      background: #D97706;
      color: white;
      text-align: center;
      border-radius: 12px;
      font-weight: 700;
      font-size: 18px;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(217, 119, 6, 0.3);
    }
    
    .back-btn:hover {
      background: #B45309;
    }
    
    /* Modal Overlay */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal-content {
      background: white;
      border-radius: 16px;
      width: 100%;
      max-width: 900px;
      height: 80vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #E5E7EB;
    }
    
    .modal-header h2 {
      font-size: 18px;
      font-weight: 600;
    }
    
    .modal-close {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      border: none;
      background: #F3F4F6;
      font-size: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:hover {
      background: #E5E7EB;
    }
    
    .modal-iframe {
      flex: 1;
      border: none;
      width: 100%;
    }
    
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      color: #6B7280;
    }
    
    .loading .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #E5E7EB;
      border-top-color: #D97706;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .error {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
      padding: 40px;
      color: #DC2626;
    }
  </style>
</head>
<body>
  <!-- Splash Screen -->
  <div id="splash" class="splash">
    <div class="splash-logo">KING STREET CARDS</div>
    <div class="splash-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="2" y="3" width="20" height="18" rx="2" />
        <path d="M12 8v4m0 4h.01" />
        <path d="M8 12h8" />
      </svg>
    </div>
    <div class="splash-text">Tap NFC to View Card</div>
    <div class="splash-subtext">Hold your phone near the card tag</div>
  </div>

  <!-- Main Content -->
  <div id="app" class="main-content">
    <div class="loading">
      <div class="spinner"></div>
      <div>Loading card info...</div>
    </div>
  </div>

  <!-- CardLadder Modal -->
  <div id="clModal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Sales History</h2>
        <button class="modal-close" onclick="closeModal()">×</button>
      </div>
      <iframe id="clIframe" class="modal-iframe"></iframe>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://jltbftzrgnfxxrrmmqlp.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpsdGJmdHpyZ25meHhycm1tcWxwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk4MDAzNTAsImV4cCI6MjA4NTM3NjM1MH0.le74kvc9j7qf7eGH84L5iZ-ng5m6ZmiyXH9-zykJRZQ';

    async function supabaseQuery(endpoint) {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`
        }
      });
      return response.json();
    }

    function formatCurrency(value) {
      if (value === null || value === undefined || isNaN(value)) return '—';
      return `$${parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    function formatDate(dateStr) {
      if (!dateStr) return '—';
      return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function getPlaceholderHTML() {
      return `
        <div class="placeholder-image">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <rect x="3" y="2" width="18" height="20" rx="2" />
            <circle cx="12" cy="10" r="3" />
            <path d="M6 18h12" />
          </svg>
          <span>No Image</span>
        </div>
      `;
    }

    function showSplash() {
      document.getElementById('splash').style.display = 'flex';
      document.getElementById('app').classList.remove('active');
      // Clear URL params
      window.history.replaceState({}, '', window.location.pathname);
    }

    function openModal(url) {
      document.getElementById('clIframe').src = url;
      document.getElementById('clModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('clModal').classList.remove('active');
      document.getElementById('clIframe').src = '';
    }

    // Close modal on overlay click
    document.getElementById('clModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    async function loadCard() {
      const params = new URLSearchParams(window.location.search);
      const kscId = params.get('id');
      
      if (!kscId) {
        // No ID - show splash screen
        document.getElementById('splash').style.display = 'flex';
        document.getElementById('app').classList.remove('active');
        return;
      }

      // Hide splash, show loading
      document.getElementById('splash').style.display = 'none';
      document.getElementById('app').classList.add('active');

      try {
        const cards = await supabaseQuery(`cards?ksc_id=eq.${kscId}`);
        if (!cards || cards.length === 0) {
          showError('Card not found');
          return;
        }
        const card = cards[0];

        const priceHistory = await supabaseQuery(`price_history?ksc_id=eq.${kscId}&source=eq.cardladder&order=fetched_at.desc&limit=1`);
        const clPrice = priceHistory?.[0] || null;

        const ebayListings = await supabaseQuery(`ebay_listings?ksc_id=eq.${kscId}&order=price.asc&limit=5`);
        const binListings = (ebayListings || []).filter(l => l.buying_option?.includes('FIXED_PRICE'));

        renderCard(card, clPrice, binListings);
      } catch (e) {
        console.error(e);
        showError('Failed to load card data');
      }
    }

    function showError(message) {
      document.getElementById('app').innerHTML = `
        <div class="error">
          <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
          <div style="font-size: 20px; font-weight: 600;">${message}</div>
          <button class="back-btn" onclick="showSplash()">Back to Scanner</button>
        </div>
      `;
    }

    function renderCard(card, clPrice, ebayListings) {
      const clValue = clPrice?.price ? parseFloat(clPrice.price) : null;
      
      // CardLadder Sales Link API
      const clUrl = card.grader && card.cert 
        ? `https://app.cardladder.com/search?grader=${card.grader.toLowerCase()}&cert=${card.cert}`
        : null;
      
      document.getElementById('app').innerHTML = `
        <div class="header">
          <h1>KING STREET CARDS</h1>
        </div>

        <div class="card-image-container">
          ${card.front_image_url 
            ? `<img src="${card.front_image_url}" alt="Card" class="card-image">`
            : getPlaceholderHTML()
          }
        </div>

        <div class="card-title">
          <div class="year-brand">${card.year || ''} ${card.brand || ''}</div>
          <div class="subject">${card.subject || 'Unknown Card'}</div>
          ${card.card_number ? `<div class="year-brand">#${card.card_number}</div>` : ''}
          <div class="grade-badges">
            <span class="badge badge-grader">${(card.grader || 'PSA').toUpperCase()}</span>
            <span class="badge badge-grade">${card.grade || '—'}${card.grade_description && card.grade_description !== card.grade ? '' : ''}</span>
          </div>
        </div>

        <div class="section">
          <div class="section-title">Population</div>
          <div class="pop-grid">
            <div class="pop-item">
              <div class="value">${card.population?.toLocaleString() ?? '—'}</div>
              <div class="label">This Grade</div>
            </div>
            <div class="pop-item">
              <div class="value">${card.population_higher?.toLocaleString() ?? '—'}</div>
              <div class="label">Higher Grades</div>
            </div>
          </div>
          ${card.psa_url ? `
            <a href="${card.psa_url}" target="_blank" class="link-btn secondary">View on PSA</a>
          ` : ''}
        </div>

        <div class="section">
          <div class="section-title">Pricing</div>
          ${clPrice ? `
          <div class="price-main">
            <div class="value">${formatCurrency(clValue)}</div>
            <div class="label">Estimated Value</div>
          </div>
          <div class="price-details">
            <div class="price-detail">
              <div class="label">Last Sale</div>
              <div class="value">${formatCurrency(clPrice?.last_sale_price)}</div>
              <div class="sub">${formatDate(clPrice?.last_sale_date)}</div>
            </div>
            <div class="price-detail">
              <div class="label">1 Year Volume</div>
              <div class="value">${clPrice?.velocity_1yr ?? '—'}</div>
              <div class="sub">sales</div>
            </div>
          </div>
          ${clUrl ? `
            <button class="link-btn" onclick="openModal('${clUrl}')">View Sales History</button>
          ` : ''}
          ` : '<div class="no-listings">No pricing data available</div>'}
        </div>

        <div class="section">
          <div class="section-title">Available on eBay</div>
          ${ebayListings.length > 0 ? ebayListings.map(listing => `
            <a href="${listing.item_url}" target="_blank" class="ebay-listing">
              ${listing.image_url 
                ? `<img src="${listing.image_url}" alt="">`
                : `<div style="width:60px;height:60px;background:#E5E7EB;border-radius:8px;"></div>`
              }
              <div class="info">
                <div class="title">${listing.title}</div>
                <div class="seller">${listing.seller || 'eBay Seller'}</div>
              </div>
              <div class="price">${formatCurrency(listing.price)}</div>
            </a>
          `).join('') : `
            <div class="no-listings">No active listings found</div>
          `}
        </div>

        <button class="back-btn" onclick="showSplash()">Scan Another Card</button>
      `;
    }

    // Initialize
    loadCard();

    // Listen for URL changes (in case of SPA navigation)
    window.addEventListener('popstate', loadCard);
  </script>
</body>
</html>
